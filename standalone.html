<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FinWing - Standalone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
  </head>
  <body class="bg-slate-950 text-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // Small Icon helper using lucide UMD
      const Icon = ({ name, size = 20, className = "", strokeWidth = 2, fill = "none" }) => {
        const ref = useRef(null);
        useEffect(() => {
          if (!ref.current) return;
          ref.current.innerHTML = '';
          const iconDef = lucide.icons[name];
          if (!iconDef) return;
          const node = lucide.createElement(iconDef);
          node.setAttribute('width', size);
          node.setAttribute('height', size);
          node.setAttribute('stroke-width', strokeWidth);
          if (fill !== 'none') node.setAttribute('fill', fill);
          ref.current.appendChild(node);
        }, [name, size, strokeWidth, fill]);
        return <span ref={ref} className={className}></span>;
      };

      // Simple LLM simulator used when there is no backend.
      async function callLLMSimulator(prompt) {
        await new Promise(r => setTimeout(r, 700));
        if (!prompt) return 'Sage mir, was du analysiert haben möchtest.';
        const p = prompt.toLowerCase();
        if (p.includes('runway') || p.includes('puffer')) return 'Runway: ~45 Tage bei aktuellem Burn-Rate. Fokus: Personal & Energie.';
        if (p.includes('hebel') || p.includes('hebel')) return 'Größter Hebel: Personal, danach Wareneinsatz.';
        if (p.includes('catering')) return 'Catering zeigt -40%: Akquise und paketangebote prüfen.';
        return 'Das ist ein Demo-Antwort. In der echten App verbindet sich FinWing mit einem LLM-Backend.';
      }

      // Hook replacement (local) to replicate useLLMChat behaviour
      function useLLMChatLocal({ systemPrompt } = {}) {
        const [messages, setMessages] = useState(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);

        async function askLLM(userContent) {
          setError(null);
          setIsLoading(true);
          try {
            const reply = await callLLMSimulator(userContent);
            const updated = [
              ...messages,
              { role: 'user', content: userContent },
              { role: 'assistant', content: reply }
            ];
            setMessages(updated);
            return reply;
          } catch (err) {
            setError(err.message || 'Fehler bei der KI-Anfrage');
            throw err;
          } finally {
            setIsLoading(false);
          }
        }

        return { messages, isLoading, error, askLLM };
      }

      // AskFinWingAI component (uses local hook)
      function AskFinWingAI() {
        const [input, setInput] = useState('');
        const { messages, isLoading, error, askLLM } = useLLMChatLocal({ systemPrompt: 'Du bist FinWing, ein pragmatischer Finanz-Co-Pilot.' });

        const lastAssistant = [...messages].reverse().find(m => m.role === 'assistant');

        async function handleSubmit(e) {
          e.preventDefault();
          if (!input.trim() || isLoading) return;
          await askLLM(input.trim());
          setInput('');
        }

        return (
          <section className="rounded-2xl bg-slate-900 border border-slate-800 p-4 space-y-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center">
                  <Icon name="Sparkles" className="w-4 h-4 text-indigo-300" />
                </div>
                <div>
                  <p className="text-sm font-medium">Frag FinWing (Demo)</p>
                  <p className="text-xs text-slate-400">Beispiel: „Wie kritisch ist mein Runway?“</p>
                </div>
              </div>
            </div>

            <form onSubmit={handleSubmit} className="flex items-center gap-2">
              <input
                className="flex-1 bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-sm outline-none focus:border-indigo-500"
                placeholder="Frage an die KI eingeben…"
                value={input}
                onChange={(e) => setInput(e.target.value)}
              />
              <button type="submit" disabled={isLoading || !input.trim()} className="inline-flex items-center justify-center w-9 h-9 rounded-full bg-indigo-500 disabled:bg-slate-700 text-white">
                {isLoading ? <Icon name="Loader" className="animate-spin"/> : <Icon name="Send" />}
              </button>
            </form>

            {error && <p className="text-xs text-red-400">{error}</p>}

            {lastAssistant && (
              <div className="mt-2 rounded-xl bg-slate-950 border border-slate-800 p-3 text-sm text-slate-100">{lastAssistant.content}</div>
            )}
          </section>
        );
      }

      function CockpitView() {
        return (
          <div className="space-y-4">
            <header>
              <p className="text-xs uppercase text-slate-400">FinWing • Demo</p>
              <h1 className="text-xl font-semibold">Cockpit</h1>
            </header>
            <section className="rounded-2xl bg-slate-900 border border-slate-800 p-4 space-y-1">
              <p className="text-sm font-medium">Demo-Kennzahlen (Mock)</p>
              <p className="text-xs text-slate-400">Dies ist eine lauffähige Demo der FinWing-UI ohne Backend.</p>
            </section>
            <AskFinWingAI />
          </div>
        );
      }

      function SandboxView() {
        return (
          <div className="space-y-4">
            <h1 className="text-xl font-bold">Sandbox</h1>
            <p className="text-xs text-slate-400">Interaktive Szenarien (Platzhalter)</p>
          </div>
        );
      }

      function JournalView() {
        return (
          <div className="space-y-4">
            <h1 className="text-xl font-bold">Journal</h1>
            <p className="text-xs text-slate-400">Missionen & Historie (Platzhalter)</p>
          </div>
        );
      }

      function DataImportView() {
        return (
          <div className="space-y-4">
            <h1 className="text-xl font-bold">Import</h1>
            <p className="text-xs text-slate-400">CSV / Buchungsdaten importieren (Platzhalter)</p>
          </div>
        );
      }

      const VIEW = { COCKPIT: 'cockpit', SANDBOX: 'sandbox', JOURNAL: 'journal', IMPORT: 'import' };

      function App() {
        const [activeView, setActiveView] = useState(VIEW.COCKPIT);

        return (
          <div className="min-h-screen flex flex-col bg-slate-950 text-slate-50">
            <main className="flex-1 max-w-xl mx-auto w-full px-4 pb-20 pt-4 space-y-4">
              {activeView === VIEW.COCKPIT && <CockpitView />}
              {activeView === VIEW.SANDBOX && <SandboxView />}
              {activeView === VIEW.JOURNAL && <JournalView />}
              {activeView === VIEW.IMPORT && <DataImportView />}
            </main>

            <nav className="fixed bottom-0 left-0 right-0 border-t border-slate-800 bg-slate-950/95 backdrop-blur">
              <div className="max-w-xl mx-auto flex justify-between px-6 py-2">
                <button onClick={() => setActiveView(VIEW.COCKPIT)} className={`flex flex-col items-center gap-0.5 text-xs ${activeView===VIEW.COCKPIT? 'text-indigo-400':'text-slate-400'}`}>
                  <Icon name="Home" className="w-5 h-5" />
                  <span>Home</span>
                </button>

                <button onClick={() => setActiveView(VIEW.SANDBOX)} className={`flex flex-col items-center gap-0.5 text-xs ${activeView===VIEW.SANDBOX? 'text-indigo-400':'text-slate-400'}`}>
                  <Icon name="SlidersHorizontal" className="w-5 h-5" />
                  <span>Sandbox</span>
                </button>

                <button onClick={() => setActiveView(VIEW.JOURNAL)} className={`flex flex-col items-center gap-0.5 text-xs ${activeView===VIEW.JOURNAL? 'text-indigo-400':'text-slate-400'}`}>
                  <Icon name="BookOpen" className="w-5 h-5" />
                  <span>Journal</span>
                </button>

                <button onClick={() => setActiveView(VIEW.IMPORT)} className={`flex flex-col items-center gap-0.5 text-xs ${activeView===VIEW.IMPORT? 'text-indigo-400':'text-slate-400'}`}>
                  <Icon name="Upload" className="w-5 h-5" />
                  <span>Import</span>
                </button>
              </div>
            </nav>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
